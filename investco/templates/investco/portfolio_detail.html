{% extends 'investco/base.html' %}
{% load humanize %}

{% block title %}{{ portfolio.name }} - InvestCo{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'investco:home' %}">Home</a></li>
                <li class="breadcrumb-item"><a href="{% url 'investco:portfolio_list' %}">Portfolios</a></li>
                <li class="breadcrumb-item active">{{ portfolio.name }}</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1><i class="fas fa-briefcase"></i> {{ portfolio.name }}</h1>
                {% if portfolio.description %}
                    <p class="text-muted">{{ portfolio.description }}</p>
                {% endif %}
            </div>
            <div>
                <div class="btn-group me-2" role="group">
                    <button type="button" class="btn btn-info dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="fas fa-chart-line"></i> Performance Reports
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{% url 'investco:portfolio_performance' portfolio.id %}">
                            <i class="fas fa-chart-area"></i> Portfolio Performance
                        </a></li>
                        <li><a class="dropdown-item" href="{% url 'investco:time_period_report' portfolio.id %}">
                            <i class="fas fa-calendar"></i> Time Period Report
                        </a></li>
                        <li><a class="dropdown-item" href="{% url 'investco:asset_allocation_report' portfolio.id %}">
                            <i class="fas fa-pie-chart"></i> Asset Allocation
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="{% url 'investco:comparative_performance' %}?portfolios={{ portfolio.id }}">
                            <i class="fas fa-balance-scale"></i> Compare Performance
                        </a></li>
                    </ul>
                </div>
                <a href="/admin/investco/investment/add/?portfolio={{ portfolio.id }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add Investment
                </a>
                <a href="/admin/investco/portfolio/{{ portfolio.id }}/change/" class="btn btn-outline-secondary">
                    <i class="fas fa-edit"></i> Edit Portfolio
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Portfolio Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card dashboard-card">
            <div class="card-body">
                <h6 class="text-muted">Total Value</h6>
                <h3 class="portfolio-value">${{ total_value|floatformat:2|intcomma }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card dashboard-card">
            <div class="card-body">
                <h6 class="text-muted">Total Investments</h6>
                <h3 class="portfolio-value">{{ investments.count }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card dashboard-card">
            <div class="card-body">
                <h6 class="text-muted">Total Cost</h6>
                <h3 class="portfolio-value">${{ total_cost|floatformat:2|intcomma }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card dashboard-card">
            <div class="card-body">
                <h6 class="text-muted">Gain/Loss</h6>
                <h3 class="portfolio-value {% if total_gain_loss >= 0 %}gain-positive{% else %}gain-negative{% endif %}">
                    ${{ total_gain_loss|floatformat:2|intcomma }}
                </h3>
            </div>
        </div>
    </div>
</div>

<!-- Investments Table -->
<div class="row">
    <div class="col-12">
        <div class="card dashboard-card">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="fas fa-chart-line"></i> Investments</h5>
            </div>
            <div class="card-body p-0">
                {% if investments %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Symbol/Name</th>
                                    <th class="text-end">Shares</th>
                                    <th class="text-end">Avg Cost</th>
                                    <th class="text-end">Current Price</th>
                                    <th class="text-end">Total Cost</th>
                                    <th class="text-end">Current Value</th>
                                    <th class="text-end">Gain/Loss</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for investment in investments %}
                                <tr class="investment-row">
                                    <td>
                                        <span class="badge bg-secondary">{{ investment.get_investment_type }}</span>
                                    </td>
                                    <td>
                                        <strong>{{ investment.symbol|default:investment.name }}</strong>
                                        {% if investment.symbol and investment.name != investment.symbol %}
                                            <br><small class="text-muted">{{ investment.name }}</small>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">{{ investment.shares|floatformat:2|intcomma }}</td>
                                    <td class="text-end">${{ investment.average_cost|floatformat:2|intcomma }}</td>
                                    <td class="text-end">${{ investment.current_price|floatformat:2|intcomma }}</td>
                                    <td class="text-end">${{ investment.total_cost|floatformat:2|intcomma }}</td>
                                    <td class="text-end">${{ investment.current_value|floatformat:2|intcomma }}</td>
                                    <td class="text-end">
                                        <span class="{% if investment.gain_loss >= 0 %}gain-positive{% else %}gain-negative{% endif %}">
                                            ${{ investment.gain_loss|floatformat:2|intcomma }}
                                            <br>
                                            <small>({{ investment.gain_loss_percentage|floatformat:2 }}%)</small>
                                        </span>
                                    </td>
                                    <td class="text-end">
                                        <a href="{% url 'investco:investment_performance' investment.id %}"
                                           class="btn btn-sm btn-outline-info btn-action"
                                           title="Performance Report">
                                            <i class="fas fa-chart-line"></i>
                                        </a>
                                        <a href="/admin/investco/investment/{{ investment.id }}/change/"
                                           class="btn btn-sm btn-outline-primary btn-action"
                                           title="Edit Investment">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="/admin/investco/transaction/add/?investment={{ investment.id }}"
                                           class="btn btn-sm btn-outline-success btn-action"
                                           title="Add Transaction">
                                            <i class="fas fa-plus"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="p-4 text-center">
                        <p class="text-muted mb-3">No investments in this portfolio yet.</p>
                        <a href="/admin/investco/investment/add/?portfolio={{ portfolio.id }}" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add Your First Investment
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Recent Transactions -->
{% if investments %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card dashboard-card">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="fas fa-history"></i> Recent Transactions</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Investment</th>
                                <th>Type</th>
                                <th class="text-end">Shares</th>
                                <th class="text-end">Price</th>
                                <th class="text-end">Amount</th>
                                <th class="text-end">Fee</th>
                                <th class="text-end">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for investment in investments %}
                                {% for transaction in investment.transactions.all|slice:":5" %}
                                <tr>
                                    <td>{{ transaction.date|date:"M d, Y H:i" }}</td>
                                    <td>{{ investment.symbol|default:investment.name }}</td>
                                    <td><span class="badge bg-info">{{ transaction.get_transaction_type_display }}</span></td>
                                    <td class="text-end">{% if transaction.shares %}{{ transaction.shares|floatformat:2 }}{% else %}-{% endif %}</td>
                                    <td class="text-end">{% if transaction.price %}<small>$</small>{{ transaction.price|floatformat:2 }}{% else %}-{% endif %}</td>
                                    <td class="text-end">{% if transaction.amount %}<small>$</small>{{ transaction.amount|floatformat:2 }}{% else %}-{% endif %}</td>
                                    <td class="text-end"><small>$</small>{{ transaction.fee|floatformat:2 }}</td>
                                    <td class="text-end"><strong><small>$</small>{{ transaction.total_amount|floatformat:2 }}</strong></td>
                                </tr>
                                {% endfor %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
