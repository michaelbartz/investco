{% extends 'investco/base.html' %}
{% load humanize %}

{% block title %}{{ investment.name }} Statements - InvestCo{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'investco:home' %}">Home</a></li>
                <li class="breadcrumb-item"><a href="{% url 'investco:portfolio_detail' investment.portfolio.id %}">{{ investment.portfolio.name }}</a></li>
                <li class="breadcrumb-item"><a href="{% url 'investco:investment_performance' investment.id %}">{{ investment.name }}</a></li>
                <li class="breadcrumb-item active">Statements</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h1><i class="fas fa-file-invoice"></i> {{ investment.name }} Statements</h1>
                <p class="text-muted">{{ investment.get_investment_type }} - View and manage investment statements</p>
            </div>
            <div>
                <a href="{% url 'investco:investment_performance' investment.id %}" class="btn btn-outline-secondary me-2">
                    <i class="fas fa-chart-line"></i> Back to Performance
                </a>
                {% if investment.get_investment_type == 'Annuity' %}
                <a href="/admin/investco/annuitystatement/add/?investment={{ investment.id }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add Statement
                </a>
                {% elif investment.get_investment_type == '401k' %}
                <a href="/admin/investco/retirement401kstatement/add/?investment={{ investment.id }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add Statement
                </a>
                {% else %}
                <a href="/admin/investco/statement/add/?investment={{ investment.id }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add Statement
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Statements List -->
<div class="row">
    <div class="col-12">
        <div class="card dashboard-card">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="fas fa-list"></i> All Statements ({{ statements.count }})</h5>
            </div>
            <div class="card-body p-0">
                {% if statements %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Statement Date</th>
                                <th>Period</th>
                                <th class="text-end">Beginning Value</th>
                                <th class="text-end">Ending Value</th>
                                <th class="text-end">Change</th>
                                {% if investment.get_investment_type == '401(k) Retirement Account' %}
                                <th class="text-end">Contributions</th>
                                <th class="text-end">Gain/Loss</th>
                                {% elif investment.get_investment_type == 'Brokerage Account' %}
                                <th class="text-end">Deposits</th>
                                <th class="text-end">Income</th>
                                {% else %}
                                <th class="text-end">Premiums</th>
                                <th class="text-end">Withdrawals</th>
                                {% endif %}
                                <th class="text-center">Reconciles</th>
                                <th class="text-center">Chains</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for statement in statements %}
                            {% if statement.annuitystatement %}
                            <tr>
                                <td>
                                    <strong>{{ statement.statement_date|date:"M d, Y" }}</strong>
                                    {% if statement.document %}
                                    <br><small class="text-muted"><i class="fas fa-paperclip"></i> Has attachment</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">
                                        {{ statement.period_start|date:"M d" }} - {{ statement.period_end|date:"M d, Y" }}
                                    </small>
                                </td>
                                <td class="text-end">${{ statement.annuitystatement.beginning_value|floatformat:2|intcomma }}</td>
                                <td class="text-end"><strong>${{ statement.annuitystatement.ending_value|floatformat:2|intcomma }}</strong></td>
                                <td class="text-end {% if statement.annuitystatement.net_change >= 0 %}text-success{% else %}text-danger{% endif %}">
                                    ${{ statement.annuitystatement.net_change|floatformat:2|intcomma }}
                                </td>
                                <td class="text-end">
                                    {% if statement.annuitystatement.premiums > 0 %}
                                    ${{ statement.annuitystatement.premiums|floatformat:2|intcomma }}
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    {% if statement.annuitystatement.withdrawals > 0 %}
                                    ${{ statement.annuitystatement.withdrawals|floatformat:2|intcomma }}
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if statement.annuitystatement.reconciles %}
                                    <span class="badge bg-success">✓</span>
                                    {% else %}
                                    <span class="badge bg-warning">✗</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if statement.annuitystatement.chains_with_previous is None %}
                                    <span class="badge bg-secondary" title="First statement">-</span>
                                    {% elif statement.annuitystatement.chains_with_previous %}
                                    <span class="badge bg-success" title="Chains correctly with previous statement">✓</span>
                                    {% else %}
                                    <span class="badge bg-danger" title="Gap: ${{ statement.annuitystatement.chain_gap|floatformat:2|intcomma }}">✗</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <a href="{% url 'investco:statement_detail' statement.id %}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye"></i> View
                                    </a>
                                    <a href="/admin/investco/annuitystatement/{{ statement.id }}/change/" class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </td>
                            </tr>
                            {% elif statement.retirement401kstatement %}
                            <tr>
                                <td>
                                    <strong>{{ statement.statement_date|date:"M d, Y" }}</strong>
                                    {% if statement.document %}
                                    <br><small class="text-muted"><i class="fas fa-paperclip"></i> Has attachment</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">
                                        {{ statement.period_start|date:"M d" }} - {{ statement.period_end|date:"M d, Y" }}
                                    </small>
                                </td>
                                <td class="text-end">${{ statement.retirement401kstatement.beginning_value|floatformat:2|intcomma }}</td>
                                <td class="text-end"><strong>${{ statement.retirement401kstatement.ending_value|floatformat:2|intcomma }}</strong></td>
                                <td class="text-end {% if statement.retirement401kstatement.calculated_change >= 0 %}text-success{% else %}text-danger{% endif %}">
                                    ${{ statement.retirement401kstatement.calculated_change|floatformat:2|intcomma }}
                                </td>
                                <td class="text-end">
                                    {% if statement.retirement401kstatement.total_contributions > 0 %}
                                    ${{ statement.retirement401kstatement.total_contributions|floatformat:2|intcomma }}
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-end {% if statement.retirement401kstatement.investment_gain_loss >= 0 %}text-success{% else %}text-danger{% endif %}">
                                    ${{ statement.retirement401kstatement.investment_gain_loss|floatformat:2|intcomma }}
                                </td>
                                <td class="text-center">
                                    {% if statement.retirement401kstatement.reconciles %}
                                    <span class="badge bg-success">✓</span>
                                    {% else %}
                                    <span class="badge bg-warning">✗</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if statement.retirement401kstatement.chains_with_previous is None %}
                                    <span class="badge bg-secondary" title="First statement">-</span>
                                    {% elif statement.retirement401kstatement.chains_with_previous %}
                                    <span class="badge bg-success" title="Chains correctly with previous statement">✓</span>
                                    {% else %}
                                    <span class="badge bg-danger" title="Gap: ${{ statement.retirement401kstatement.chain_gap|floatformat:2|intcomma }}">✗</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <a href="{% url 'investco:statement_detail' statement.id %}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye"></i> View
                                    </a>
                                    <a href="/admin/investco/retirement401kstatement/{{ statement.id }}/change/" class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </td>
                            </tr>
                            {% elif statement.brokerageaccountstatement %}
                            <tr>
                                <td>
                                    <strong>{{ statement.statement_date|date:"M d, Y" }}</strong>
                                    {% if statement.document %}
                                    <br><small class="text-muted"><i class="fas fa-paperclip"></i> Has attachment</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">
                                        {{ statement.period_start|date:"M d" }} - {{ statement.period_end|date:"M d, Y" }}
                                    </small>
                                </td>
                                <td class="text-end">${{ statement.brokerageaccountstatement.beginning_value|floatformat:2|intcomma }}</td>
                                <td class="text-end"><strong>${{ statement.brokerageaccountstatement.ending_value|floatformat:2|intcomma }}</strong></td>
                                <td class="text-end {% if statement.brokerageaccountstatement.calculated_change >= 0 %}text-success{% else %}text-danger{% endif %}">
                                    ${{ statement.brokerageaccountstatement.calculated_change|floatformat:2|intcomma }}
                                </td>
                                <td class="text-end">
                                    {% if statement.brokerageaccountstatement.deposits > 0 %}
                                    ${{ statement.brokerageaccountstatement.deposits|floatformat:2|intcomma }}
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    {% if statement.brokerageaccountstatement.total_income > 0 %}
                                    ${{ statement.brokerageaccountstatement.total_income|floatformat:2|intcomma }}
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if statement.brokerageaccountstatement.reconciles %}
                                    <span class="badge bg-success">✓</span>
                                    {% else %}
                                    <span class="badge bg-warning">✗</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if statement.brokerageaccountstatement.chains_with_previous is None %}
                                    <span class="badge bg-secondary" title="First statement">-</span>
                                    {% elif statement.brokerageaccountstatement.chains_with_previous %}
                                    <span class="badge bg-success" title="Chains correctly with previous statement">✓</span>
                                    {% else %}
                                    <span class="badge bg-danger" title="Gap: ${{ statement.brokerageaccountstatement.chain_gap|floatformat:2|intcomma }}">✗</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <a href="{% url 'investco:statement_detail' statement.id %}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye"></i> View
                                    </a>
                                    <a href="/admin/investco/brokerageaccountstatement/{{ statement.id }}/change/" class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="p-5 text-center text-muted">
                    <i class="fas fa-file-invoice fa-3x mb-3"></i>
                    <h5>No statements yet</h5>
                    <p>Add your first statement to start tracking your investment activity.</p>
                    {% if investment.get_investment_type == 'Annuity' %}
                    <a href="/admin/investco/annuitystatement/add/?investment={{ investment.id }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add First Statement
                    </a>
                    {% elif investment.get_investment_type == '401k' %}
                    <a href="/admin/investco/retirement401kstatement/add/?investment={{ investment.id }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add First Statement
                    </a>
                    {% else %}
                    <a href="/admin/investco/statement/add/?investment={{ investment.id }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add First Statement
                    </a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
