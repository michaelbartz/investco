{% extends "admin/base_site.html" %}
{% load static %}

{% block content %}
<div id="content-main">
    {% if messages %}
    <ul class="messagelist">
        {% for message in messages %}
        <li class="{{ message.tags }}">{{ message }}</li>
        {% endfor %}
    </ul>
    {% endif %}

    {% if not parsed_data %}
    <!-- Step 1: Upload PDF -->
    <div class="module">
        <h2>Step 1: Upload PDF Statement</h2>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form-row">
                <div>
                    <label for="pdf_file">Select PDF file:</label>
                    <input type="file" name="pdf_file" id="pdf_file" accept=".pdf" required>
                </div>
            </div>
            <div class="submit-row">
                <input type="submit" value="Parse PDF" class="default">
                {% if statement_type == '401k' %}
                <a href="{% url 'admin:investco_retirement401kstatement_changelist' %}" class="button cancel-link">Cancel</a>
                {% elif statement_type == 'brokerage' %}
                <a href="{% url 'admin:investco_brokerageaccountstatement_changelist' %}" class="button cancel-link">Cancel</a>
                {% else %}
                <a href="{% url 'admin:investco_annuitystatement_changelist' %}" class="button cancel-link">Cancel</a>
                {% endif %}
            </div>
        </form>
    </div>

    <div class="module" style="margin-top: 20px;">
        <h3>Instructions</h3>
        <ul>
            {% if statement_type == '401k' %}
            <li>Select a 401k quarterly statement PDF (John Hancock, etc.)</li>
            {% elif statement_type == 'brokerage' %}
            <li>Select a brokerage account statement PDF (M Holdings, etc.)</li>
            {% else %}
            <li>Select an annuity quarterly statement PDF (Jackson, TIAA, Valic, etc.)</li>
            {% endif %}
            <li>The system will extract key financial data automatically</li>
            <li>You'll review and verify the extracted values before creating the statement</li>
            <li>This works best with standard quarterly statements</li>
        </ul>
    </div>

    {% else %}
    <!-- Step 2: Verify and Confirm -->
    <div class="module">
        <h2>Step 2: Verify Extracted Data</h2>
        <p><strong>Source:</strong> {{ parsed_data.pdf_filename }}</p>

        {% if validation.warnings %}
        <div class="messagelist">
            {% for warning in validation.warnings %}
            <div class="warning">⚠️ {{ warning }}</div>
            {% endfor %}
        </div>
        {% endif %}

        <form method="post">
            {% csrf_token %}

            <fieldset class="module aligned">
                {% if statement_type == '401k' %}
                <h2>401k Account Selection</h2>
                {% if parsed_data.account_number %}
                <div class="form-row">
                    <div>
                        <label>Account Number (from PDF):</label>
                        <span style="font-weight: bold;">{{ parsed_data.account_number }}</span>
                    </div>
                </div>
                {% endif %}
                <div class="form-row">
                    <div>
                        <label for="account" class="required">401k Account:</label>
                        <select name="account" id="account" required>
                            <option value="">Select an account...</option>
                            {% for account in accounts %}
                            <option value="{{ account.id }}" {% if parsed_data.matched_401k_id == account.id %}selected{% endif %}>
                                {{ account.name }} ({{ account.employer_name }}){% if account.account_number %} - {{ account.account_number }}{% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                {% elif statement_type == 'brokerage' %}
                <h2>Brokerage Account Selection</h2>
                {% if parsed_data.account_number %}
                <div class="form-row">
                    <div>
                        <label>Account Number (from PDF):</label>
                        <span style="font-weight: bold;">{{ parsed_data.account_number }}</span>
                    </div>
                </div>
                {% endif %}
                <div class="form-row">
                    <div>
                        <label for="account" class="required">Brokerage Account:</label>
                        <select name="account" id="account" required>
                            <option value="">Select an account...</option>
                            {% for account in accounts %}
                            <option value="{{ account.id }}" {% if parsed_data.matched_account_id == account.id %}selected{% endif %}>
                                {{ account.name }} ({{ account.brokerage_firm }}){% if account.account_number %} - {{ account.account_number }}{% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                {% else %}
                <h2>Annuity Selection</h2>
                {% if parsed_data.policy_number %}
                <div class="form-row">
                    <div>
                        <label>Policy Number (from PDF):</label>
                        <span style="font-weight: bold;">{{ parsed_data.policy_number }}</span>
                    </div>
                </div>
                {% endif %}
                <div class="form-row">
                    <div>
                        <label for="annuity" class="required">Annuity:</label>
                        <select name="annuity" id="annuity" required>
                            <option value="">Select an annuity...</option>
                            {% for annuity in annuities %}
                            <option value="{{ annuity.id }}" {% if parsed_data.matched_annuity_id == annuity.id %}selected{% endif %}>
                                {{ annuity.name }} ({{ annuity.insurance_company }}){% if annuity.policy_number %} - {{ annuity.policy_number }}{% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                {% endif %}
            </fieldset>

            <fieldset class="module aligned">
                <h2>Statement Information</h2>
                <div class="form-row">
                    <div>
                        <label for="statement_date" class="required">Statement Date:</label>
                        <input type="date" name="statement_date" id="statement_date" value="{{ parsed_data.statement_date }}" required>
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label for="period_start" class="required">Period Start:</label>
                        <input type="date" name="period_start" id="period_start" value="{{ parsed_data.period_start }}" required>
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label for="period_end" class="required">Period End:</label>
                        <input type="date" name="period_end" id="period_end" value="{{ parsed_data.period_end }}" required>
                    </div>
                </div>
            </fieldset>

            <fieldset class="module aligned">
                <h2>Account Values</h2>
                <div class="form-row">
                    <div>
                        <label for="beginning_value" class="required">Beginning Value:</label>
                        <input type="text" name="beginning_value" id="beginning_value" value="{{ parsed_data.beginning_value }}" required>
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label for="ending_value" class="required">Ending Value:</label>
                        <input type="text" name="ending_value" id="ending_value" value="{{ parsed_data.ending_value }}" required>
                    </div>
                </div>
            </fieldset>

            {% if statement_type == 'brokerage' %}
            <fieldset class="module aligned">
                <h2>Deposits and Withdrawals</h2>
                <div class="form-row">
                    <div>
                        <label for="deposits" class="required">Deposits:</label>
                        <input type="text" name="deposits" id="deposits" value="{{ parsed_data.deposits }}" required>
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label for="withdrawals" class="required">Withdrawals:</label>
                        <input type="text" name="withdrawals" id="withdrawals" value="{{ parsed_data.withdrawals }}" required>
                    </div>
                </div>
            </fieldset>

            <fieldset class="module aligned">
                <h2>Income</h2>
                <div class="form-row">
                    <div>
                        <label for="dividends" class="required">Dividends:</label>
                        <input type="text" name="dividends" id="dividends" value="{{ parsed_data.dividends }}" required>
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label for="interest" class="required">Interest:</label>
                        <input type="text" name="interest" id="interest" value="{{ parsed_data.interest }}" required>
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label for="capital_gains" class="required">Capital Gains:</label>
                        <input type="text" name="capital_gains" id="capital_gains" value="{{ parsed_data.capital_gains }}" required>
                    </div>
                </div>
            </fieldset>

            <fieldset class="module aligned">
                <h2>Period Activity</h2>
                <div class="form-row">
                    <div>
                        <label for="market_change" class="required">Market Change:</label>
                        <input type="text" name="market_change" id="market_change" value="{{ parsed_data.market_change }}" required>
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label for="fees" class="required">Fees:</label>
                        <input type="text" name="fees" id="fees" value="{{ parsed_data.fees }}" required>
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label for="other_activity" class="required">Other Activity:</label>
                        <input type="text" name="other_activity" id="other_activity" value="{{ parsed_data.other_activity }}" required>
                    </div>
                </div>
            </fieldset>

            <fieldset class="module aligned">
                <h2>Account Allocation (Optional)</h2>
                <div class="form-row">
                    <div>
                        <label for="money_market">Money Market:</label>
                        <input type="text" name="money_market" id="money_market" value="{{ parsed_data.money_market }}">
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label for="equities">Equities:</label>
                        <input type="text" name="equities" id="equities" value="{{ parsed_data.equities }}">
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label for="fixed_income">Fixed Income:</label>
                        <input type="text" name="fixed_income" id="fixed_income" value="{{ parsed_data.fixed_income }}">
                    </div>
                </div>
            </fieldset>
            {% elif statement_type == '401k' %}
            <fieldset class="module aligned">
                <h2>Contributions</h2>
                <div class="form-row">
                    <div>
                        <label for="employee_contributions" class="required">Employee Contributions:</label>
                        <input type="text" name="employee_contributions" id="employee_contributions" value="{{ parsed_data.employee_contributions }}" required>
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label for="employer_contributions" class="required">Employer Contributions:</label>
                        <input type="text" name="employer_contributions" id="employer_contributions" value="{{ parsed_data.employer_contributions }}" required>
                    </div>
                </div>
            </fieldset>

            <fieldset class="module aligned">
                <h2>Period Activity</h2>
                <div class="form-row">
                    <div>
                        <label for="investment_gain_loss" class="required">Investment Gain/Loss:</label>
                        <input type="text" name="investment_gain_loss" id="investment_gain_loss" value="{{ parsed_data.investment_gain_loss }}" required>
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label for="withdrawals" class="required">Withdrawals:</label>
                        <input type="text" name="withdrawals" id="withdrawals" value="{{ parsed_data.withdrawals }}" required>
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label for="fees" class="required">Fees:</label>
                        <input type="text" name="fees" id="fees" value="{{ parsed_data.fees }}" required>
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label for="loan_payments" class="required">Loan Payments:</label>
                        <input type="text" name="loan_payments" id="loan_payments" value="{{ parsed_data.loan_payments }}" required>
                    </div>
                </div>
            </fieldset>

            <fieldset class="module aligned">
                <h2>Vesting Information (Optional)</h2>
                <div class="form-row">
                    <div>
                        <label for="vested_balance">Vested Balance:</label>
                        <input type="text" name="vested_balance" id="vested_balance" value="{{ parsed_data.vested_balance }}">
                    </div>
                </div>
            </fieldset>
            {% else %}
            <fieldset class="module aligned">
                <h2>Period Activity</h2>
                <div class="form-row">
                    <div>
                        <label for="premiums" class="required">Premiums:</label>
                        <input type="text" name="premiums" id="premiums" value="{{ parsed_data.premiums }}" required>
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label for="withdrawals" class="required">Withdrawals:</label>
                        <input type="text" name="withdrawals" id="withdrawals" value="{{ parsed_data.withdrawals }}" required>
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label for="tax_withholding" class="required">Tax Withholding:</label>
                        <input type="text" name="tax_withholding" id="tax_withholding" value="{{ parsed_data.tax_withholding }}" required>
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label for="net_change" class="required">Net Change:</label>
                        <input type="text" name="net_change" id="net_change" value="{{ parsed_data.net_change }}" required>
                    </div>
                </div>
            </fieldset>

            <fieldset class="module aligned">
                <h2>Guaranteed Benefits (Optional)</h2>
                <div class="form-row">
                    <div>
                        <label for="remaining_guaranteed_balance">Remaining Guaranteed Balance:</label>
                        <input type="text" name="remaining_guaranteed_balance" id="remaining_guaranteed_balance" value="{{ parsed_data.remaining_guaranteed_balance }}">
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label for="death_benefit">Death Benefit:</label>
                        <input type="text" name="death_benefit" id="death_benefit" value="{{ parsed_data.death_benefit }}">
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label for="earnings_determination_baseline">Earnings Determination Baseline:</label>
                        <input type="text" name="earnings_determination_baseline" id="earnings_determination_baseline" value="{{ parsed_data.earnings_determination_baseline }}">
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label for="guaranteed_withdrawal_balance_bonus_baseline">GWB Bonus Baseline:</label>
                        <input type="text" name="guaranteed_withdrawal_balance_bonus_baseline" id="guaranteed_withdrawal_balance_bonus_baseline" value="{{ parsed_data.guaranteed_withdrawal_balance_bonus_baseline }}">
                    </div>
                </div>
            </fieldset>
            {% endif %}

            <div class="submit-row">
                <input type="submit" name="confirm_import" value="Create Statement" class="default">
                <input type="submit" name="cancel_import" value="Cancel" class="button cancel-link">
            </div>
        </form>
    </div>

    <div class="module" style="margin-top: 20px;">
        <h3>Review Checklist</h3>
        <ul>
            <li>✓ Verify all dollar amounts match the PDF</li>
            <li>✓ Check that the statement date is correct</li>
            {% if statement_type == '401k' %}
            <li>✓ Ensure the correct 401k account is selected</li>
            {% elif statement_type == 'brokerage' %}
            <li>✓ Ensure the correct brokerage account is selected</li>
            {% else %}
            <li>✓ Ensure the correct annuity is selected</li>
            {% endif %}
            <li>✓ Review any warnings about reconciliation mismatches</li>
        </ul>
    </div>
    {% endif %}
</div>
{% endblock %}
